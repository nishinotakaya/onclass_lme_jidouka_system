version: "3.9"

services:
  db:
    image: mysql:5.7
    platform: linux/amd64
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      # MYSQL_USER: ${MYSQL_USER}
      # MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    command: mysqld --character-set-server=utf8mb4 --collation-server=utf8mb4_general_ci
    volumes:
      - mysql-data:/var/lib/mysql
    # 外部からMySQLに接続したい場合のみ公開
    ports:
      - "${MYSQL_PORT_ON_HOST:-3009}:3306"
    healthcheck:
      test:
        [
          "CMD",
          "mysqladmin",
          "ping",
          "-h",
          "127.0.0.1",
          "-p${MYSQL_ROOT_PASSWORD}",
        ]
      interval: 5s
      timeout: 3s
      retries: 20

  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    # 外部からRedisを触らないならポート公開は不要（必要ならコメント解除）
    # ports:
    #   - "${REDIS_PORT_ON_HOST:-6370}:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 20

  api:
    build:
      context: .
      dockerfile: Dockerfile
    user: "0:0"
    command: bash -c "rm -f tmp/pids/server.pid && bundle exec rails s -p ${RAILS_PORT:-3000} -b '0.0.0.0'"
    volumes:
      - .:/myapp
      - bundle:/usr/local/bundle
      # ▼ Google サービスアカウント鍵（ホスト→コンテナ）
      - ./config/keys/google_service_account.json:/myapp/config/keys/google_service_account.json:ro
    environment:
      TZ: ${TZ}
      RAILS_ENV: ${RAILS_ENV}
      # DBは database.yml で host: db を参照
      REDIS_URL: ${REDIS_URL}
      SIDEKIQ_REDIS_URL: ${SIDEKIQ_REDIS_URL}

      # ▼ Onclass API（既存のONLINE_*はそのまま維持）
      ONLINE_CLASS_API_BASE: ${ONLINE_CLASS_API_BASE}
      ONLINE_CLASS_LOGIN_PATH: ${ONLINE_CLASS_LOGIN_PATH}
      ONLINE_CLASS_EMAIL: ${ONLINE_CLASS_EMAIL}
      ONLINE_CLASS_PASSWORD: ${ONLINE_CLASS_PASSWORD}

      # （必要なら OnclassAuthClient 用の別名も設定しておくと安心）
      ONCLASS_BASE_URL: ${ONCLASS_BASE_URL:-https://api.the-online-class.com}
      ONCLASS_LOGIN_PATH: ${ONCLASS_LOGIN_PATH:-/v1/enterprise_manager/auth/sign_in}
      ONCLASS_EMAIL: ${ONCLASS_EMAIL:-${ONLINE_CLASS_EMAIL}}
      ONCLASS_PASSWORD: ${ONCLASS_PASSWORD:-${ONLINE_CLASS_PASSWORD}}

      # ▼ Google Sheets 書き込み用
      GOOGLE_APPLICATION_CREDENTIALS: /myapp/config/keys/google_service_account.json
      # 鍵ファイルをマウントできない場合の代替（どちらか一方を .env に入れる）
      # GOOGLE_SERVICE_ACCOUNT_JSON: ${GOOGLE_SERVICE_ACCOUNT_JSON}
      # GOOGLE_SERVICE_ACCOUNT_JSON_BASE64: ${GOOGLE_SERVICE_ACCOUNT_JSON_BASE64}
      ONCLASS_SPREADSHEET_ID: ${ONCLASS_SPREADSHEET_ID}
      ONCLASS_SHEET_NAME: ${ONCLASS_SHEET_NAME:-フロントコース受講生}

      # ▼ LME Cookie自動更新用
      GOOGLE_EMAIL: ${GOOGLE_EMAIL}
      GOOGLE_PASSWORD: ${GOOGLE_PASSWORD}
    ports:
      - "${API_PORT_ON_HOST:-3008}:${RAILS_PORT:-3000}"
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    tty: true
    stdin_open: true

  sidekiq:
    build:
      context: .
    user: "0:0"
    command: bash -c "bundle exec sidekiq"
    init: true
    volumes:
      - .:/myapp
      - bundle:/usr/local/bundle
      # ▼ Google サービスアカウント鍵（ホスト→コンテナ）
      - ./config/keys/google_service_account.json:/myapp/config/keys/google_service_account.json:ro
    environment:
      TZ: ${TZ}
      RAILS_ENV: ${RAILS_ENV}
      REDIS_URL: ${REDIS_URL}
      SIDEKIQ_REDIS_URL: ${SIDEKIQ_REDIS_URL}

      # ▼ Onclass API（既存名を維持）
      ONLINE_CLASS_API_BASE: ${ONLINE_CLASS_API_BASE}
      ONLINE_CLASS_LOGIN_PATH: ${ONLINE_CLASS_LOGIN_PATH}
      ONLINE_CLASS_EMAIL: ${ONLINE_CLASS_EMAIL}
      ONLINE_CLASS_PASSWORD: ${ONLINE_CLASS_PASSWORD}

      # （必要なら OnclassAuthClient 用の別名も設定）
      ONCLASS_BASE_URL: ${ONCLASS_BASE_URL:-https://api.the-online-class.com}
      ONCLASS_LOGIN_PATH: ${ONCLASS_LOGIN_PATH:-/v1/enterprise_manager/auth/sign_in}
      ONCLASS_EMAIL: ${ONCLASS_EMAIL:-${ONLINE_CLASS_EMAIL}}
      ONCLASS_PASSWORD: ${ONCLASS_PASSWORD:-${ONLINE_CLASS_PASSWORD}}

      # ▼ Google Sheets 書き込み用（Worker はこちらで使う）
      GOOGLE_APPLICATION_CREDENTIALS: /myapp/config/keys/google_service_account.json
      # ファイルマウントできない場合の代替（どちらか一方）
      # GOOGLE_SERVICE_ACCOUNT_JSON: ${GOOGLE_SERVICE_ACCOUNT_JSON}
      # GOOGLE_SERVICE_ACCOUNT_JSON_BASE64: ${GOOGLE_SERVICE_ACCOUNT_JSON_BASE64}
      ONCLASS_SPREADSHEET_ID: ${ONCLASS_SPREADSHEET_ID}
      ONCLASS_SHEET_NAME: ${ONCLASS_SHEET_NAME:-フロントコース受講生}

      # ▼ LME Cookie自動更新用（Worker はこちらで使う）
      GOOGLE_EMAIL: ${GOOGLE_EMAIL}
      GOOGLE_PASSWORD: ${GOOGLE_PASSWORD}
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy

volumes:
  mysql-data:
  bundle:
  redis_data:
